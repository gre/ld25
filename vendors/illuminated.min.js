(function(a){function w(b,d,c){var e=w.epsilon||1E-6,f,g=[];"object"===typeof b&&"number"===typeof d&&(d=b);"number"===typeof d?(f=d,d=f*f+c*c):(f=d.x,c=d.y,d=d.length2());var h=c*Math.sqrt(d-b*b),j=Math.acos((-b*f+h)/d),k=Math.acos((-b*f-h)/d);d=b*Math.cos(j);var j=b*Math.sin(j),h=b*Math.cos(k),m=b*Math.sin(k);b=new a.Vec2(f+h,c+m);g.push(b);k=b.length2();b=new a.Vec2(f+d,c-j);g.push(b);var l=b.length2();if(Math.abs(k-l)<e)return g;b=new a.Vec2(f+h,c-m);g.push(b);h=b.length2();if(Math.abs(l-h)<e)return[b,
g[1]];if(Math.abs(k-h)<e)return[g[0],b];b=new a.Vec2(f+d,c+j);g.push(b);f=b.length2();return Math.abs(h-f)<e?[g[2],b]:Math.abs(l-f)<e?[g[1],b]:Math.abs(k-f)<e?[g[0],b]:g}function p(b,d){var a=document.createElement("canvas");a.width=b;a.height=d;return{canvas:a,ctx:a.getContext("2d"),w:b,h:d}}function r(b,a,c){var e=a[0];b.moveTo(e.x,e.y);for(var f=1;f<a.length;++f)e=a[f],b.lineTo(e.x,e.y);!c&&2<a.length&&(e=a[0],b.lineTo(e.x,e.y))}function l(b){for(var a=1;a<arguments.length;++a){var c=arguments[a];
if(c)for(var e in c)void 0!==c[e]&&(b[e]=c[e])}}function x(){}function q(b,a){x.prototype=a.prototype;b.prototype=new x;b.prototype.constructor=b;b.prototype.__super=a.prototype}a.Vec2=function(b,a){this.x=b||0;this.y=a||0};a.Vec2.prototype.copy=function(){return new a.Vec2(this.x,this.y)};a.Vec2.prototype.dot=function(b){return b.x*this.x+b.y*this.y};a.Vec2.prototype.sub=function(b){return new a.Vec2(this.x-b.x,this.y-b.y)};a.Vec2.prototype.add=function(b){return new a.Vec2(this.x+b.x,this.y+b.y)};
a.Vec2.prototype.mul=function(b){return new a.Vec2(this.x*b,this.y*b)};a.Vec2.prototype.inv=function(){return this.mul(-1)};a.Vec2.prototype.dist2=function(b){var a=this.x-b.x;b=this.y-b.y;return a*a+b*b};a.Vec2.prototype.normalize=function(){var b=Math.sqrt(this.length2());return new a.Vec2(this.x/b,this.y/b)};a.Vec2.prototype.length2=function(){return this.x*this.x+this.y*this.y};a.Vec2.prototype.toString=function(){return this.x+","+this.y};a.Vec2.prototype.inBound=function(b,a){return b.x<this.x&&
this.x<a.x&&b.y<this.y&&this.y<a.y};a.Light=function(b){l(this,a.Light.defaults,b)};a.Light.defaults={position:new a.Vec2,distance:100,diffuse:0.8};a.Light.prototype.render=function(){};a.Light.prototype.mask=function(b){var a=this._getVisibleMaskCache();b.drawImage(a.canvas,Math.round(this.position.x-a.w/2),Math.round(this.position.y-a.h/2))};a.Light.prototype.bounds=function(){return{topleft:new a.Vec2(this.position.x-this.distance,this.position.y-this.distance),bottomright:new a.Vec2(this.position.x+
this.distance,this.position.y+this.distance)}};a.Light.prototype.center=function(){return new a.Vec2(this.distance,this.distance)};a.Light.prototype.forEachSample=function(b){b(this.position)};a.Light.prototype._getVisibleMaskCache=function(){var b=Math.floor(1.4*this.distance),a=""+b;this.vismaskhash!=a&&(this.vismaskhash=a,a=this._vismaskcache=p(2*b,2*b),b=a.ctx.createRadialGradient(b,b,0,b,b,b),b.addColorStop(0,"rgba(0,0,0,1)"),b.addColorStop(1,"rgba(0,0,0,0)"),a.ctx.fillStyle=b,a.ctx.fillRect(0,
0,a.w,a.h));return this._vismaskcache};a.OpaqueObject=function(b){l(this,a.OpaqueObject.defaults,b)};a.OpaqueObject.defaults={diffuse:0.8};a.OpaqueObject.prototype.cast=function(){};a.OpaqueObject.prototype.path=function(){};a.OpaqueObject.prototype.bounds=function(){return{topleft:new a.Vec2,bottomright:new a.Vec2}};a.OpaqueObject.prototype.contains=function(){return!1};a.Lamp=function(b){l(this,a.Light.defaults,a.Lamp.defaults,b)};q(a.Lamp,a.Light);a.Lamp.defaults={color:"rgba(250,220,150,0.8)",
radius:0,samples:1,angle:0,roughness:0};a.Lamp.prototype._getHashCache=function(){return[this.color,this.distance,this.diffuse,this.angle,this.roughness].toString()};a.Lamp.prototype.center=function(){return new a.Vec2((1-Math.cos(this.angle)*this.roughness)*this.distance,(1+Math.sin(this.angle)*this.roughness)*this.distance)};a.Light.prototype.bounds=function(){var b=(new a.Vec2(Math.cos(this.angle),-Math.sin(this.angle))).mul(this.roughness*this.distance);return{topleft:new a.Vec2(this.position.x+
b.x-this.distance,this.position.y+b.y-this.distance),bottomright:new a.Vec2(this.position.x+b.x+this.distance,this.position.y+b.y+this.distance)}};a.Lamp.prototype.mask=function(b){var d=this._getVisibleMaskCache(),c=(new a.Vec2(Math.cos(this.angle),-Math.sin(this.angle))).mul(this.roughness*this.distance);b.drawImage(d.canvas,Math.round(this.position.x+c.x-d.w/2),Math.round(this.position.y+c.y-d.h/2))};a.Lamp.prototype._getGradientCache=function(b){var d=this._getHashCache();if(this._cacheHashcode==
d)return this._gcache;this._cacheHashcode=d;var d=Math.round(this.distance),c=2*d,c=p(c,c);b=c.ctx.createRadialGradient(b.x,b.y,0,d,d,d);b.addColorStop(Math.min(1,this.radius/this.distance),this.color);b.addColorStop(1,a.getRGBA(this.color,0));c.ctx.fillStyle=b;c.ctx.fillRect(0,0,c.w,c.h);return this._gcache=c};a.Lamp.prototype.render=function(b){var a=this.center(),c=this._getGradientCache(a);b.drawImage(c.canvas,Math.round(this.position.x-a.x),Math.round(this.position.y-a.y))};a.Lamp.prototype.forEachSample=
function(b){for(var d=0;d<this.samples;++d){var c=d*y,e=Math.sqrt(d/this.samples)*this.radius,c=new a.Vec2(Math.cos(c)*e,Math.sin(c)*e);b(this.position.add(c))}};a.DiscObject=function(b){l(this,a.OpaqueObject.defaults,a.DiscObject.defaults,b)};q(a.DiscObject,a.OpaqueObject);a.DiscObject.defaults={center:new a.Vec2,radius:20};a.DiscObject.prototype.cast=function(b,a,c){var e=this.center,f=e.sub(a),g=w(this.radius,f),h=g[0],j=g[1],g=h.add(a);a=j.add(a);c=(c.bottomright.x-c.topleft.x+(c.bottomright.y-
c.topleft.y))/2;f=f.normalize().mul(c);h=h.normalize().mul(c);j=j.normalize().mul(c);c=g.add(f);var k=a.add(f),h=g.add(h),j=a.add(j),f=Math.atan2(f.x,-f.y);b.beginPath();r(b,[a,j,k,c,h,g],!0);b.arc(e.x,e.y,this.radius,f,f+Math.PI);b.fill()};a.DiscObject.prototype.path=function(b){b.arc(this.center.x,this.center.y,this.radius,0,z)};a.DiscObject.prototype.bounds=function(){return{topleft:new a.Vec2(this.center.x-this.radius,this.center.y-this.radius),bottomright:new a.Vec2(this.center.x+this.radius,
this.center.y+this.radius)}};a.DiscObject.prototype.contains=function(b){return b.dist2(this.center)<this.radius*this.radius};a.PolygonObject=function(b){l(this,a.OpaqueObject.defaults,a.PolygonObject.defaults,b)};q(a.PolygonObject,a.OpaqueObject);a.PolygonObject.defaults={points:[]};a.PolygonObject.prototype.bounds=function(){for(var b=this.points[0].copy(),a=b.copy(),c=1;c<this.points.length;++c){var e=this.points[c];e.x>a.x&&(a.x=e.x);e.y>a.y&&(a.y=e.y);e.x<b.x&&(b.x=e.x);e.y<b.y&&(b.y=e.y)}return{topleft:b,
bottomright:a}};a.PolygonObject.prototype.contains=function(b){var a=this.points,c=a.length-1,e=b.x,f=b.y,g=!1;for(b=0;b<a.length;b++){if((a[b].y<f&&a[c].y>=f||a[c].y<f&&a[b].y>=f)&&(a[b].x<=e||a[c].x<=e))a[b].x+(f-a[b].y)/(a[c].y-a[b].y)*(a[c].x-a[b].x)<e&&(g=!g);c=b}return g};a.PolygonObject.prototype.path=function(a){r(a,this.points)};a.PolygonObject.prototype.cast=function(a,d,c){var e=(c.bottomright.x-c.topleft.x+(c.bottomright.y-c.topleft.y))/2;this._forEachVisibleEdges(d,c,function(c,g,h,j,
k){var m=h.inv().dot(k)/k.length2(),m=(0>m?c:1<m?g:c.add(k.mul(m))).sub(d),m=m.normalize().mul(e);h=h.normalize().mul(e);j=j.normalize().mul(e);k=c.add(m);m=g.add(m);h=c.add(h);j=g.add(j);a.beginPath();r(a,[c,g,j,m,k,h]);a.fill()})};a.PolygonObject.prototype._forEachVisibleEdges=function(b,d,c){for(var e=this.points[this.points.length-1],f,g=0;g<this.points.length;++g,e=f)if(f=this.points[g],e.inBound(d.topleft,d.bottomright)){var h=e.sub(b),j=f.sub(b),k=f.sub(e);0>(new a.Vec2(k.y,-k.x)).dot(h)&&
c(e,f,h,j,k)}};a.RectangleObject=function(b){l(this,a.OpaqueObject.defaults,a.PolygonObject.defaults,a.RectangleObject.defaults,b);this.syncFromTopleftBottomright()};q(a.RectangleObject,a.PolygonObject);a.RectangleObject.defaults={topleft:new a.Vec2,bottomright:new a.Vec2};a.RectangleObject.prototype.syncFromTopleftBottomright=function(){var b=this.topleft,d=new a.Vec2(this.bottomright.x,this.topleft.y),c=this.bottomright,e=new a.Vec2(this.topleft.x,this.bottomright.y);this.points=[b,d,c,e]};a.RectangleObject.prototype.fill=
function(a){var d=this.points[0].x,c=this.points[0].y;a.rect(d,c,this.points[2].x-d,this.points[2].y-c)};a.LineObject=function(b){l(this,a.OpaqueObject.defaults,a.PolygonObject.defaults,a.LineObject.defaults,b);this.syncFromAB()};q(a.LineObject,a.PolygonObject);a.LineObject.defaults={a:new a.Vec2,b:new a.Vec2};a.LineObject.prototype.syncFromAB=function(){this.points=[this.a,this.b]};a.Lighting=function(b){l(this,a.Lighting.defaults,b)};a.Lighting.defaults={light:new a.Light,objects:[]};a.Lighting.prototype.createCache=
function(a,d){this._cache=p(a,d);this._castcache=p(a,d)};a.Lighting.prototype.cast=function(a){var d=this.light,c=d.samples,e=this._castcache,f=e.ctx;f.clearRect(0,0,e.w,e.h);f.fillStyle="rgba(0,0,0,"+Math.round(100/c)/100+")";var g=d.bounds(),h=this.objects;d.forEachSample(function(a){for(var b=0;b<h.length;++b)if(h[b].contains(a)){f.fillRect(g.topleft.x,g.topleft.y,g.bottomright.x-g.topleft.x,g.bottomright.y-g.topleft.y);return}h.forEach(function(b){b.cast(f,a,g)})});h.forEach(function(a){var b=
void 0===a.diffuse?0.8:a.diffuse,b=b*d.diffuse;f.fillStyle="rgba(0,0,0,"+(1-b)+")";f.beginPath();a.path(f);f.fill()});a.drawImage(e.canvas,0,0)};a.Lighting.prototype.compute=function(a,d){(!this._cache||this._cache.w!=a||this._cache.h!=d)&&this.createCache(a,d);var c=this._cache.ctx,e=this.light;c.save();c.clearRect(0,0,c.canvas.width,c.canvas.height);e.render(c);c.globalCompositeOperation="destination-out";this.cast(c);c.restore()};a.Lighting.prototype.render=function(a){a.drawImage(this._cache.canvas,
0,0)};a.DarkMask=function(b){l(this,a.DarkMask.defaults,b)};a.DarkMask.defaults={lights:[],color:"rgba(0,0,0,0.9)"};a.DarkMask.prototype.compute=function(a,d){if(!this._cache||this._cache.w!=a||this._cache.h!=d)this._cache=p(a,d);var c=this._cache.ctx;c.save();c.clearRect(0,0,a,d);c.fillStyle=this.color;c.fillRect(0,0,a,d);c.globalCompositeOperation="destination-out";this.lights.forEach(function(a){a.mask(c)});c.restore()};a.DarkMask.prototype.render=function(a){a.drawImage(this._cache.canvas,0,0)};
var y=Math.PI*(3-Math.sqrt(5)),z=2*Math.PI;a.createCanvasAnd2dContext=p;a.path=r;var u=a,n=document.createElement("canvas");n.width=n.height=1;var s=n.getContext("2d");u.getRGBA=function(a,d){s.clearRect(0,0,1,1);s.fillStyle=a;s.fillRect(0,0,1,1);var c=s.getImageData(0,0,1,1).data;return"rgba("+[c[0],c[1],c[2],d]+")"};var u=a,v=function(a){a=a.toString(16);1==a.length&&(a="0"+a);return a},n=document.createElement("canvas");n.width=n.height=1;var t=n.getContext("2d");u.extractColorAndAlpha=function(a){t.clearRect(0,
0,1,1);t.fillStyle=a;t.fillRect(0,0,1,1);a=t.getImageData(0,0,1,1).data;return{color:"#"+v(a[0])+v(a[1])+v(a[2]),alpha:Math.round(1E3*a[3]/255)/1E3}};illuminated.extend=l;a.inherit=q})(window.illuminated={});
